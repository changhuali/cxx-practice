# gcc

## -E

```sh
cc -E xxx.c -o xxx.i
```

### 预处理

- 展开所有宏定义 `#define VERSION 1.0.0`
- 处理所有条件编译 `#if #ifdef #elif #endif`
- 处理预编译指令, 所有头文件会递归展开 `#include <xxx.h>`

  - 遇到的头文件会以`# linenum filename flags`的形式出现在`.i`文件中

    - linenum 文件行号
    - flags 可能的值为 1、2、3、4
      - 1 标志进入一个文件
      - 2 标志回到一个文件
      - 3 表示后续内容来自系统头文件
      - 4 表示后续的内容应该被当做包含在`extern "C"`块中

    > 由 flags 可以得出, 头文件采用 DFS 的方式进行展开, 通过行号可以判断后续代码是在源码中的哪一行

- 删除注释(会保留删除注释后留下的空行) `// /**/`

### 预处理指令

预处理指令格式`#name`

- #和 name 之间可以有空格，name 称为指令名
- name 不会进行宏展开

  ```c
  #define foo define
  #foo // 这里的foo不会展开, 导致#foo不是一个有效预处理指令
  ```

- 用户不能自定义新的预处理指令
- 不能跨行, 但是可以用`\`对多行进行连接

### 头文件

头文件包括了公用的接口声明和宏定义

- 系统头文件, 声明了部分操作系统的接口和宏定义
  ```C
  #include <file> // 在一组系统目录中查找该文件, 这组系统目录的值取决于系统、GCC配置以及GCC的安装目录
  ```
- 用户头文件, 声明了用户共享代码的接口和宏定义
  ```C
  #include "file" // 首先在当前文件所在目录下查找该文件, 最后按系统头文件进行查找
  ```

可以通过下列脚本查看系统头文件查找目录

```sh
cpp -v /dev/null -o /dev/null
```

- -I 指定户头/系统头文件查找目录, 其优先级高于系统目录, 并按照从左到右依次查找
- -iquote 指定用户头文件查找目录
- -isystem 指定系统头文件查找目录, 这些目录中查找到的头文件算作系统头文件
- -nostdinc 指定忽略默认的系统查找目录

> `#include_next`是 GCC 的一种拓展, 表示从当前文件的查找目录之后的目录开始查找, 可以有效防止循环引用

#### 通过哨兵宏保证头文件只被处理一次

```C
/* File foo.  */
#ifndef FILE_FOO_SEEN
#define FILE_FOO_SEEN

the entire file

#endif /* !FILE_FOO_SEEN */
```

CPP 提供了两种另外的方法保证头文件只会被处理一次, 但是可移植性都很差, 并不推荐使用

```c
#import <xxx.h> // Objective-C标准
#pragma once // 放到头文件中
```

#### 系统头文件

GCC 对系统头文件会有部分特殊处理, 所有警告(`#warning`产生除外)都会被抑制

哪些头文件算作系统头文件:

- 部分特殊目录中查找到的头文件
- 在`-isystem`和`-idirafter`指定的目录中查找到的头文件
- `pragma GCC system_header`指令后面引入的头文件
